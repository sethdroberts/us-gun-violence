{"version":3,"sources":["../../src/utils.js"],"names":["MAX_LATITUDE","createDeckInstance","map","overlay","deck","props","userData","_googleMap","destroyDeckInstance","eventListeners","click","dblclick","mousemove","mouseout","Deck","canvas","createDeckCanvas","initialViewState","longitude","latitude","zoom","controller","_eventListeners","eventType","addListener","evt","handleMouseEvent","container","getPanes","overlayLayer","deckCanvas","document","createElement","Object","assign","style","position","appendChild","remove","finalize","parentNode","removeChild","getViewState","getDiv","firstChild","width","offsetWidth","height","offsetHeight","projection","getProjection","bounds","getBounds","ne","getNorthEast","sw","getSouthWest","topRight","fromLatLngToDivPixel","bottomLeft","nwContainerPx","google","maps","Point","nw","fromContainerPixelToLatLng","nwDivPx","leftOffset","x","topOffset","y","mapWidth","getWorldWidth","mapCount","Math","ceil","floor","scale","log2","getZoom","centerPx","centerContainer","lat","lng","abs","center","LatLng","fromLatLngToContainerPixel","left","top","pitch","getTilt","getEventPixel","event","pixel","point","getViewports","project","latLng","type","mockEvent","offsetCenter","srcEvent","_lastPointerDownInfo","pickObject","tapCount","_onEvent","_onPointerMove"],"mappings":"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","sourcesContent":["/* global document, google */\nimport {Deck} from '@deck.gl/core';\n\n// https://en.wikipedia.org/wiki/Web_Mercator_projection#Formulas\nconst MAX_LATITUDE = 85.05113;\n\n/**\n * Get a new deck instance\n * @param map (google.maps.Map) - The parent Map instance\n * @param overlay (google.maps.OverlayView) - A maps Overlay instance\n * @param [deck] (Deck) - a previously created instances\n */\nexport function createDeckInstance(map, overlay, deck) {\n  if (deck) {\n    if (deck.props.userData._googleMap === map) {\n      return deck;\n    }\n    // deck instance was created for a different map\n    destroyDeckInstance(deck);\n  }\n\n  const eventListeners = {\n    click: null,\n    dblclick: null,\n    mousemove: null,\n    mouseout: null\n  };\n\n  deck = new Deck({\n    canvas: createDeckCanvas(overlay),\n    initialViewState: {\n      longitude: 0,\n      latitude: 0,\n      zoom: 1\n    },\n    controller: false,\n    userData: {\n      _googleMap: map,\n      _eventListeners: eventListeners\n    }\n  });\n\n  // Register event listeners\n  for (const eventType in eventListeners) {\n    eventListeners[eventType] = map.addListener(eventType, evt =>\n      handleMouseEvent(deck, eventType, evt)\n    );\n  }\n\n  return deck;\n}\n\nfunction createDeckCanvas(overlay) {\n  const container = overlay.getPanes().overlayLayer;\n  const deckCanvas = document.createElement('canvas');\n  Object.assign(deckCanvas.style, {\n    // map container position is always non-static\n    position: 'absolute'\n  });\n\n  container.appendChild(deckCanvas);\n  return deckCanvas;\n}\n\n/**\n * Safely remove a deck instance\n * @param deck (Deck) - a previously created instances\n */\nexport function destroyDeckInstance(deck) {\n  const {_eventListeners: eventListeners} = deck.props.userData;\n\n  // Unregister event listeners\n  for (const eventType in eventListeners) {\n    eventListeners[eventType].remove();\n  }\n\n  deck.finalize();\n\n  // Remove canvas\n  deck.canvas.parentNode.removeChild(deck.canvas);\n}\n\n/* eslint-disable max-statements */\n/**\n * Get the current view state\n * @param map (google.maps.Map) - The parent Map instance\n * @param overlay (google.maps.OverlayView) - A maps Overlay instance\n */\nexport function getViewState(map, overlay) {\n  // The map fills the container div unless it's in fullscreen mode\n  // at which point the first child of the container is promoted\n  const container = map.getDiv().firstChild;\n  const width = container.offsetWidth;\n  const height = container.offsetHeight;\n\n  // Canvas position relative to draggable map's container depends on\n  // overlayView's projection, not the map's. Have to use the center of the\n  // map for this, not the top left, for the same reason as above.\n  const projection = overlay.getProjection();\n\n  const bounds = map.getBounds();\n  const ne = bounds.getNorthEast();\n  const sw = bounds.getSouthWest();\n  const topRight = projection.fromLatLngToDivPixel(ne);\n  const bottomLeft = projection.fromLatLngToDivPixel(sw);\n\n  // google maps places overlays in a container anchored at the map center.\n  // the container CSS is manipulated during dragging.\n  // We need to update left/top of the deck canvas to match the base map.\n  const nwContainerPx = new google.maps.Point(0, 0);\n  const nw = projection.fromContainerPixelToLatLng(nwContainerPx);\n  const nwDivPx = projection.fromLatLngToDivPixel(nw);\n  let leftOffset = nwDivPx.x;\n  let topOffset = nwDivPx.y;\n\n  // Adjust horizontal offset - position the viewport at the map in the center\n  const mapWidth = projection.getWorldWidth();\n  const mapCount = Math.ceil(width / mapWidth);\n  leftOffset -= Math.floor(mapCount / 2) * mapWidth;\n\n  // Compute fractional zoom.\n  const scale = height ? (bottomLeft.y - topRight.y) / height : 1;\n  // When resizing aggressively, occasionally ne and sw are the same points\n  // See https://github.com/visgl/deck.gl/issues/4218\n  const zoom = Math.log2(scale || 1) + map.getZoom() - 1;\n\n  // Compute fractional center.\n  let centerPx = new google.maps.Point(width / 2, height / 2);\n  const centerContainer = projection.fromContainerPixelToLatLng(centerPx);\n  let latitude = centerContainer.lat();\n  const longitude = centerContainer.lng();\n\n  // Adjust vertical offset - limit latitude\n  if (Math.abs(latitude) > MAX_LATITUDE) {\n    latitude = latitude > 0 ? MAX_LATITUDE : -MAX_LATITUDE;\n    const center = new google.maps.LatLng(latitude, longitude);\n    centerPx = projection.fromLatLngToContainerPixel(center);\n    topOffset += centerPx.y - height / 2;\n  }\n\n  return {\n    width,\n    height,\n    left: leftOffset,\n    top: topOffset,\n    zoom,\n    pitch: map.getTilt(),\n    latitude,\n    longitude\n  };\n}\n/* eslint-enable max-statements */\n\nfunction getEventPixel(event, deck) {\n  if (event.pixel) {\n    return event.pixel;\n  }\n  // event.pixel may not exist when clicking on a POI\n  // https://developers.google.com/maps/documentation/javascript/reference/map#MouseEvent\n  const point = deck.getViewports()[0].project([event.latLng.lng(), event.latLng.lat()]);\n  return {\n    x: point[0],\n    y: point[1]\n  };\n}\n\n// Triggers picking on a mouse event\nfunction handleMouseEvent(deck, type, event) {\n  const mockEvent = {\n    type,\n    offsetCenter: getEventPixel(event, deck),\n    srcEvent: event\n  };\n\n  switch (type) {\n    case 'click':\n      // Hack: because we do not listen to pointer down, perform picking now\n      deck._lastPointerDownInfo = deck.pickObject(mockEvent.offsetCenter);\n      mockEvent.tapCount = 1;\n      deck._onEvent(mockEvent);\n      break;\n\n    case 'dblclick':\n      mockEvent.type = 'click';\n      mockEvent.tapCount = 2;\n      deck._onEvent(mockEvent);\n      break;\n\n    case 'mousemove':\n      mockEvent.type = 'pointermove';\n      deck._onPointerMove(mockEvent);\n      break;\n\n    case 'mouseout':\n      mockEvent.type = 'pointerleave';\n      deck._onPointerMove(mockEvent);\n      break;\n\n    default:\n      return;\n  }\n}\n"],"file":"utils.js"}